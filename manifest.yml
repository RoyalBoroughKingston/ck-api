---
defaults: &defaults
  memory: 128M
  instances: 1
  buildpack: php_buildpack
  services:
  - ((db-service-name))
  - ((redis-service-name))
  - ((search-service-name))
  env:
    APP_DEBUG: ((APP_DEBUG))
    APP_ENV: ((APP_ENV))
    APP_KEY: ((APP_KEY))
    APP_NAME: Connected Kingston
    APP_URL: ((APP_URL))
    AWS_ACCESS_KEY_ID: ((AWS_ACCESS_KEY_ID))
    AWS_SECRET_ACCESS_KEY: ((AWS_SECRET_ACCESS_KEY))
    AWS_DEFAULT_REGION: ((AWS_DEFAULT_REGION))
    AWS_BUCKET: ((AWS_BUCKET))
    BACKEND_URI: ((BACKEND_URI))
    CACHE_DRIVER: redis
    DB_CERT_PATH: /etc/ssl/certs
    DB_CONNECTION: mysql
    EMAIL_DRIVER: gov
    GEOCODE_DRIVER: google
    GLOBAL_ADMIN_EMAIL: ((GLOBAL_ADMIN_EMAIL))
    GOOGLE_API_KEY: ((GOOGLE_API_KEY))
    GOV_NOTIFY_API_KEY: ((GOV_NOTIFY_API_KEY))
    LOG_CHANNEL: errorlog
    QUEUE_DRIVER: sqs
    SMS_DRIVER: gov
    SQS_KEY: ((SQS_KEY))
    SQS_PREFIX: ((SQS_PREFIX))
    SQS_QUEUE: ((SQS_QUEUE))
    SQS_REGION: ((SQS_REGION))
    SQS_SECRET: ((SQS_SECRET))
    REDIS_CLUSTER: true
    REDIS_SCHEME: tls
    SCOUT_ELASTIC_DOCUMENT_REFRESH: "null"

applications:
- name: ck-api
  <<: *defaults
  routes:
  - route: ((route))

- name: ck-queue-worker
  <<: *defaults
  no-route: true
  command: php artisan queue:work --queue=default,search,notifications --tries=1
  health-check-type: process

- name: ck-scheduler
  <<: *defaults
  no-route: true
  command: php artisan ck:run-scheduler
  health-check-type: process
