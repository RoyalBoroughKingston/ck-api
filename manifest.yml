---
defaults: &defaults
  memory: 128M
  instances: 1
  buildpack: php_buildpack
  services:
  - ((db-service-name))
  - ((redis-service-name))
  - ((search-service-name))
  env:
    APP_DEBUG: ((APP_DEBUG))
    APP_ENV: ((APP_ENV))
    APP_KEY: ((APP_KEY))
    APP_NAME: Connected Kingston
    APP_URL: ((APP_URL))
    AWS_ACCESS_KEY_ID: ((AWS_ACCESS_KEY_ID))
    AWS_SECRET_ACCESS_KEY: ((AWS_SECRET_ACCESS_KEY))
    AWS_DEFAULT_REGION: ((AWS_DEFAULT_REGION))
    AWS_BUCKET: ((AWS_BUCKET))
    CACHE_DRIVER: redis
    DB_CERT_PATH: /etc/ssl/certs
    DB_CONNECTION: mysql
    GEOCODE_DRIVER: nominatim
    GOOGLE_API_KEY: ((GOOGLE_API_KEY))
    LOG_CHANNEL: errorlog
    MAIL_DRIVER: ((MAIL_DRIVER))
    MAIL_ENCRYPTION: tls
    MAIL_HOST: ((MAIL_HOST))
    MAIL_PASSWORD: ((MAIL_PASSWORD))
    MAIL_PORT: ((MAIL_PORT))
    MAIL_USERNAME: ((MAIL_USERNAME))
    QUEUE_DRIVER: redis
    REDIS_SCHEME: tls
    SCOUT_ELASTIC_DOCUMENT_REFRESH: null
    SESSION_DRIVER: redis

applications:
- name: ck-api
  <<: *defaults
  routes:
  - route: ((route))

- name: ck-queue-worker
  <<: *defaults
  no-route: true
  command: php artisan queue:work --queue=default,search,notifications
  health-check-type: process

- name: ck-scheduler
  <<: *defaults
  no-route: true
  command: php artisan ck:run-scheduler
  health-check-type: process
